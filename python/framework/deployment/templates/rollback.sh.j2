#!/bin/bash
# shared_libs/framework/templates/rollback.sh.j2

set -e

# Configuration
APP_NAME="{{ app_name }}"
ENVIRONMENT="{{ env }}"
API_SERVERS=({% for server in api_servers %}"{{ server }}" {% endfor %})
WORKER_SERVERS=({% for server in worker_servers %}"{{ server }}" {% endfor %})

# Get rollback version
if [ -z "$1" ]; then
    echo "ERROR: Please provide a version to rollback to"
    echo "Usage: ./rollback.sh VERSION"
    exit 1
fi
ROLLBACK_VERSION=$1

echo "Rolling back {{ app_name }} ({{ env }}) to version ${ROLLBACK_VERSION}..."

# Rollback on API servers
echo "Rolling back API servers..."
for server in "${API_SERVERS[@]}"; do
    echo "Rolling back $server..."
    
    ssh $server "cd /opt/{{ app_name }} && \
        export TAG=${ROLLBACK_VERSION} && \
        docker-compose pull && \
        docker-compose up -d --no-deps api && \
        sleep 5 && \
        docker-compose exec -T api wget --spider --quiet http://localhost:8000/status || exit 1"
    
    echo "Rolled back $server successfully"
done

echo "Rollback successful!"